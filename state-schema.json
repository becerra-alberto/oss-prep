{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "description": "Persistent state schema for .oss-prep/state.json â€” tracks phase progress, findings, and configuration across sessions.",
  "type": "object",
  "properties": {
    "schema_version": {
      "type": "integer",
      "default": 1,
      "description": "Schema version for future evolution. Increment when adding or removing fields."
    },
    "phase": {
      "type": "integer",
      "minimum": 0,
      "maximum": 10,
      "default": 0,
      "description": "Current/next phase to execute (0-9), or 10 when all phases complete."
    },
    "project_root": {
      "type": "string",
      "default": "",
      "description": "Absolute path to the git repository root."
    },
    "prep_branch": {
      "type": "string",
      "default": "oss-prep/ready",
      "description": "The branch name for preparation work."
    },
    "project_profile": {
      "type": "object",
      "description": "Detected project metadata from Phase 0 reconnaissance.",
      "properties": {
        "language": {
          "type": "string",
          "default": "",
          "description": "Primary language(s) detected."
        },
        "framework": {
          "type": "string",
          "default": "",
          "description": "Detected framework(s) or empty string if none."
        },
        "package_manager": {
          "type": "string",
          "default": "",
          "description": "Detected package manager(s) or empty string if none."
        },
        "build_system": {
          "type": "string",
          "default": "",
          "description": "Detected build system or empty string if none."
        },
        "test_framework": {
          "type": "string",
          "default": "",
          "description": "Detected test framework(s) or empty string if none."
        }
      },
      "required": ["language", "framework", "package_manager", "build_system", "test_framework"]
    },
    "findings": {
      "type": "object",
      "description": "Cumulative finding totals across all phases.",
      "properties": {
        "total": {
          "type": "integer",
          "default": 0,
          "description": "Total number of findings across all phases."
        },
        "critical": {
          "type": "integer",
          "default": 0,
          "description": "Number of CRITICAL severity findings."
        },
        "high": {
          "type": "integer",
          "default": 0,
          "description": "Number of HIGH severity findings."
        },
        "medium": {
          "type": "integer",
          "default": 0,
          "description": "Number of MEDIUM severity findings."
        },
        "low": {
          "type": "integer",
          "default": 0,
          "description": "Number of LOW severity findings."
        }
      },
      "required": ["total", "critical", "high", "medium", "low"]
    },
    "phases_completed": {
      "type": "array",
      "items": {
        "type": "integer",
        "minimum": 0,
        "maximum": 9
      },
      "default": [],
      "description": "List of completed phase numbers."
    },
    "history_flattened": {
      "type": "boolean",
      "default": false,
      "description": "Whether Phase 8 history flattening was performed."
    },
    "phase_findings": {
      "type": "object",
      "default": {},
      "description": "Per-phase aggregate finding counts, keyed by phase number as string.",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "total": {
            "type": "integer",
            "default": 0,
            "description": "Total findings in this phase."
          },
          "critical": {
            "type": "integer",
            "default": 0,
            "description": "CRITICAL findings in this phase."
          },
          "high": {
            "type": "integer",
            "default": 0,
            "description": "HIGH findings in this phase."
          },
          "medium": {
            "type": "integer",
            "default": 0,
            "description": "MEDIUM findings in this phase."
          },
          "low": {
            "type": "integer",
            "default": 0,
            "description": "LOW findings in this phase."
          },
          "status": {
            "type": "string",
            "enum": ["completed", "skipped", "failed"],
            "description": "Phase completion status."
          }
        },
        "required": ["total", "critical", "high", "medium", "low", "status"]
      }
    },
    "license_choice": {
      "type": "string",
      "default": "",
      "description": "License selected during Phase 3 preamble, consumed by Phase 5."
    },
    "readiness_rating": {
      "type": "string",
      "default": "",
      "enum": ["", "Ready", "Ready with Caveats", "Not Ready"],
      "description": "Final readiness assessment set in Phase 9."
    },
    "started_at": {
      "type": "string",
      "default": "",
      "description": "ISO 8601 timestamp of when the preparation began."
    },
    "phase_failures": {
      "type": "object",
      "default": {},
      "description": "Sub-agent failure events keyed by phase number, per PRD FR-15.",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "attempt": {
            "type": "integer",
            "description": "Number of attempts made."
          },
          "error": {
            "type": "string",
            "description": "Error description from the failed sub-agent."
          },
          "fallback": {
            "type": "string",
            "enum": ["retry", "main_context"],
            "description": "Whether the phase was retried or fell back to main context."
          }
        },
        "required": ["attempt", "error", "fallback"]
      }
    }
  },
  "required": [
    "schema_version",
    "phase",
    "project_root",
    "prep_branch",
    "project_profile",
    "findings",
    "phases_completed",
    "history_flattened",
    "phase_findings",
    "license_choice",
    "readiness_rating",
    "started_at",
    "phase_failures"
  ]
}
